# 🔴 PCAN NTU-60 训练失败分析 v3

## 📉 三次训练结果对比

| 训练轮次 | 融合准确率 | RGB准确率 | Pose准确率 | 学习率 | Pose权重 |
|---------|----------|----------|-----------|--------|---------|
| **Epoch 26 (基线)** | **89.19%** | **89.00%** | **82.50%** | N/A | 1.0 |
| 第2次训练 Epoch 1 | 88.32% ⬇️0.87% | 87.63% ⬇️1.37% | 82.01% ⬇️0.49% | 0.001 (warmup) | 2.0 |
| 第3次训练 Epoch 1 | 86.69% ⬇️2.50% | 87.56% ⬇️1.44% | 76.66% ⬇️5.84% | 0.003 | 2.0 |

---

## 🔥 核心问题：Pose权重2.0过高导致分支崩溃

### **问题表现**

```
Epoch 26 → 第3次训练 Epoch 1:
- RGB准确率:  89.00% → 87.56% (-1.44%)  ✅ 波动正常
- Pose准确率: 82.50% → 76.66% (-5.84%)  ❌ 崩溃！
- 融合准确率: 89.19% → 86.69% (-2.50%)  ❌ 严重下降
```

### **原因分析**

```python
loss_weights=[1., 2., 0.5, 1.0]
              ↑   ↑
           RGB Pose (2.0倍！)
```

**Pose权重=2.0的问题**：
1. **Loss占比过大**：Pose loss占总loss的40%+
2. **梯度不平衡**：Pose分支梯度主导更新
3. **本末倒置**：Pose分支本就较弱（82.5% vs RGB 89%），大权重反而让它震荡
4. **结果**：Pose从82.5%崩到76.66%，拖累整体性能

---

## 🔬 次要问题：学习率选择

### **两次实验对比**

| 学习率 | Warmup | Epoch 1准确率 | 说明 |
|--------|--------|-------------|------|
| 0.001 | ✅有 | 88.32% | 学习率太小，但有warmup缓冲 |
| 0.003 | ❌无 | 86.69% | 学习率过大+无warmup，权重震荡 |

**结论**：
- 0.003对于已训练26轮的模型**太大了**
- 需要更保守的0.001

---

## 📊 数据增强影响分析

第3次训练添加的增强：
```python
- ColorJitter(brightness=0.3, contrast=0.3, saturation=0.3, hue=0.1)  # 颜色增强
- RandomResizedCrop(area_range=(0.50, 1.0))  # 更激进的裁剪（原0.56→0.50）
```

**可能的负面影响**：
1. **ColorJitter对RGB影响大**：RGB分支依赖颜色特征
2. **更激进的裁剪**：可能丢失关键区域
3. **Pose分支也受影响**：虽然是热力图，但基于RGB生成

---

## ✅ 修正方案 v3（最保守）

### **已修改的配置**

```python
# 1. 降低Pose权重（关键！）
loss_weights=[1., 1.2, 0.5, 0.8]  # Pose: 2.0 → 1.2

# 2. 使用更保守的学习率
lr=0.001  # 0.003 → 0.001

# 3. 禁用ColorJitter（临时）
# dict(type='ColorJitter', ...)  # 注释掉

# 4. 其他保持不变
max_epochs=30
early_stopping: patience=15, min_delta=0.0005
```

---

## 🎯 预期效果

### **第1个Epoch检查点**

```
✅ 融合准确率应该 ≥ 88.5% (接近Epoch 26的89.19%)
✅ RGB准确率应该 ≥ 88.5%
✅ Pose准确率应该 ≥ 80.0% (不能低于80%)
✅ 学习率 = 0.001
```

### **如果仍然失败**

| 准确率范围 | 下一步操作 |
|-----------|-----------|
| 融合 < 87% | 降低学习率到0.0005 |
| Pose < 78% | 降低Pose权重到1.0 |
| RGB < 87% | 恢复原始数据增强 |

---

## 🔑 关键经验总结

### **1. Loss权重不是越大越好**

❌ **错误思路**：
> "Pose分支弱（82%），所以增加权重到2.0来强化训练"

✅ **正确思路**：
> "Pose分支弱，应该用适度权重（1.0-1.5）让它稳定学习，避免震荡"

### **2. 微调不是继续训练**

❌ **错误做法**：
- 从已训练模型出发
- 使用较大学习率（0.003）
- 增加数据增强

✅ **正确做法**：
- 从已训练模型出发
- 使用**极小**学习率（0.0005-0.001）
- **减少**或保持数据增强不变

### **3. 分支性能不平衡时的策略**

```
RGB: 89%  ← 性能好，权重保持1.0
Pose: 82% ← 性能差，权重也保持1.0或1.2

原因：
- 权重反映"重要性"，不是"弱点补偿"
- 过大权重会导致弱分支震荡
- 应该通过架构/数据改进弱分支，而非简单调权重
```

---

## 🚀 下一步操作

### **1. 重新开始训练**

```bash
cd /home/zh/ChCode/codes01/mmaction2

# 启动训练
CUDA_VISIBLE_DEVICES=0,1 bash tools/dist_train.sh \
    configs/skeleton/posec3d/rgbpose_conv3d/pcan_ntu60.py \
    2 --work-dir work_dirs/pcan_ntu60
```

### **2. 监控第1个Epoch**

```bash
# 查看验证准确率
tail -100 work_dirs/pcan_ntu60/*.log | grep "Epoch(val)"
```

**期望结果**：
```
acc/RGBPose_1:1_top1: 0.88XX  (≥ 88.5%)
acc/pose_top1: 0.80XX          (≥ 80.0%)
acc/rgb_top1: 0.88XX           (≥ 88.5%)
```

### **3. 如果第1个Epoch成功**

继续训练，期望：
- Epoch 5-10: 89-90%
- Epoch 15-20: 90-91%
- Epoch 25-30: 91%+

### **4. 如果第1个Epoch仍然失败**

**最后的兜底方案：不从checkpoint开始，从头训练50个epoch**

---

## 📌 配置文件状态

```python
# /configs/skeleton/posec3d/rgbpose_conv3d/pcan_ntu60.py

# 核心参数
loss_weights=[1., 1.2, 0.5, 0.8]  # ✅ 已修正
lr=0.001                           # ✅ 已修正
max_epochs=30                      # ✅
load_from='...epoch_26.pth'        # ✅
resume=False                       # ✅

# 数据增强
ColorJitter: 已禁用                # ✅
RandomResizedCrop: (0.50, 1.0)     # 保持
```

---

**生成时间**: 2025-11-22 12:00  
**版本**: v3 (超保守微调模式)  
**状态**: ⚠️ 准备第4次训练

