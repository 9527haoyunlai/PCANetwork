# 🚨 训练崩溃修复方案 - 从Epoch 11拯救训练

## 📊 崩溃分析

### **训练历史**

| Epoch | RGBPose | RGB | Pose | 状态 |
|-------|---------|-----|------|------|
| 1 | 7.85% | 7.84% | 4.93% | 初始 |
| 7 | **46.43%** | 55.72% | 19.89% | ✅ 大幅上升 |
| 8 | 35.40% | 49.47% | 11.52% | ❌ **暴跌11%** |
| 10 | **56.13%** | 65.04% | 15.06% | ✅ 恢复 |
| 11 | **57.45%** | 66.73% | 16.06% | ✅ **最佳** |
| 12 | 32.64% | 41.24% | 13.88% | ❌ **暴跌25%** |
| 13 | 27.69% | 39.49% | 10.86% | ❌ **继续暴跌到27%** |

---

## 🔥 **核心问题**

### **1. Pose分支彻底崩溃**
- Pose Top1从最高19.89%降到**10.86%**
- 比随机猜测（1.67%）只好9个百分点
- **Pose loss权重1.5过高，导致梯度爆炸**

### **2. 训练极度不稳定（振荡幅度30%）**
- Epoch 11: 57.45% → Epoch 13: **27.69%**（-30%！）
- 这种振荡说明：
  - 学习率太高
  - 数据增强太激进
  - 模型无法收敛

### **3. 激进数据增强 + 过拟合**
- **RandomResizedCrop(0.40, 1.0)**：裁剪范围太大
- **ColorJitter(brightness=0.4, ...)**：颜色扰动太强
- **TTA num_clips=10**：测试时增强引入噪声
- 训练集准确率95% vs 验证集27% → **严重过拟合**

---

## ✅ **修复方案**

### **配置对比**

| 参数 | 修改前（崩溃） | 修改后（保守） | 说明 |
|------|---------------|---------------|------|
| **loss_weights[pose]** | 1.5 | **1.0** | 降低Pose权重，避免崩溃 |
| **loss_weights[pose_coarse]** | 1.2 | **0.8** | 同步降低 |
| **RandomResizedCrop** | (0.40, 1.0) | **(0.56, 1.0)** | 减少裁剪激进度 |
| **ColorJitter** | ✅ 开启 | **❌ 禁用** | 移除颜色扰动 |
| **TTA num_clips** | 10 | **3** | 降低测试时增强 |
| **lr** | 0.008 | **0.005** | 降低学习率 |
| **weight_decay** | 0.0003 | **0.0005** | 增加正则化 |
| **clip_grad max_norm** | 40 | **20** | 降低梯度裁剪阈值 |
| **max_epochs** | 100 | **50** | 调整训练周期 |
| **warmup** | ✅ 5 epochs | **❌ 禁用** | 避免warmup问题 |
| **load_from** | None | **epoch_11.pth** | 从最佳点重启 |
| **resume** | True | **False** | 重置scheduler |

---

## 🎯 **预期效果**

### **稳定性改善**
- ✅ Pose分支不再崩溃（权重降低）
- ✅ 训练曲线平滑（学习率降低）
- ✅ 减少过拟合（数据增强保守）

### **性能目标**
- **短期（10 epochs）**：稳定在60-65%
- **中期（20 epochs）**：突破70%
- **长期（40 epochs）**：冲击75-80%

**注意**：95%的目标可能需要更长时间（80-100 epochs）和更多调优。

---

## 🚀 **训练命令**

### **启动训练**

```bash
cd /home/zh/ChCode/codes01/mmaction2

CUDA_VISIBLE_DEVICES=0,1 bash tools/dist_train.sh \
    configs/skeleton/posec3d/rgbpose_conv3d/pcan_ntu60_95target.py \
    2 \
    --work-dir work_dirs/pcan_ntu60_95target_rescue
```

### **监控训练**

```bash
# 实时查看日志
tail -f work_dirs/pcan_ntu60_95target_rescue/*/$(ls -t work_dirs/pcan_ntu60_95target_rescue/*/*.log | head -1)

# 查看最新验证结果
grep "Epoch(val)" work_dirs/pcan_ntu60_95target_rescue/*/*.log | tail -5
```

---

## 📐 **训练时间估算**

- **每epoch时间**：约13.5分钟
- **50 epochs总时间**：50 × 13.5 = **11.25小时**
- **预计完成时间**：约12小时后

---

## 🔍 **关键监控指标**

### **健康训练的标志**
1. ✅ **Pose Top1 > 20%**（不再崩溃）
2. ✅ **RGBPose Top1稳定上升**（不再暴跌）
3. ✅ **训练loss平滑下降**（无剧烈波动）
4. ✅ **验证集acc与训练集差距 < 15%**（不过拟合）

### **需要警惕的信号**
1. ❌ Pose Top1 < 15%（Pose又崩溃了）
2. ❌ 连续3个epoch准确率下降 > 5%（仍不稳定）
3. ❌ 训练loss突然上升（梯度爆炸）
4. ❌ GPU OOM（需降低batch_size）

---

## 📌 **配置文件状态**

**文件**: `configs/skeleton/posec3d/rgbpose_conv3d/pcan_ntu60_95target.py`

```python
# 核心修改
loss_weights=[1.0, 1.0, 0.5, 0.8],  # ✅ 平衡双分支
area_range=(0.56, 1.0),             # ✅ 保守裁剪
# ColorJitter - 已禁用              # ✅ 移除激进增强
num_clips=3,                         # ✅ 降低TTA
lr=0.005,                            # ✅ 稳健学习率
weight_decay=0.0005,                 # ✅ 增强正则化
max_epochs=50,                       # ✅ 适中周期
load_from='...epoch_11.pth',         # ✅ 从最佳点重启
resume=False,                        # ✅ 重置scheduler
```

---

## 📈 **后续优化路径**

### **如果训练稳定（60-65%）**
1. 逐步增加学习率（0.005 → 0.008）
2. 重新引入轻量数据增强（ColorJitter降低到0.2）
3. 增加训练周期（50 → 80 epochs）

### **如果仍然不稳定**
1. 进一步降低学习率（0.005 → 0.003）
2. 增加batch size（16 → 20，如果显存够）
3. 考虑使用预训练权重

### **如果要冲击90%+**
1. 使用更大的backbone（ResNet50 → ResNet101）
2. 增加训练数据（数据增强 + 伪标签）
3. 模型集成（训练多个模型融合）
4. 更长时间训练（100+ epochs）

---

**状态**: ✅ 配置已修复，准备重启训练
**预期结果**: 稳定训练，准确率逐步提升到60-70%
**生成时间**: 2025-11-22 15:30

